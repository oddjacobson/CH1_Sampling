---
title: "Statistical Analysis"
author: "Odd Jacobson"
date: "2022-12-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document shows the statistical analysis and results of our Bayesian models. These models aim to predict the home range performance based on the following predictors: 1) clumped vs spread data, 2) # of locations, 3) # of unique weeks


### Load Packages

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(bayesplot)
library(rstanarm)
library(magrittr)
library(rethinking)
library(janitor) # cleans up data for you
library(tidybayes)
library(tidybayes.rethinking)
library(modelr)
library(brms)
library(gghalves)
library(ggbeeswarm)
library(patchwork)
library(emmeans)
library(cmdstanr)
library(viridis)
library(broom.mixed)
library(ggthemes)
```

Some initial preparing
```{r}
# these options make stan run faster
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
```

### Get data frame 

```{r}
df <- readRDS("../Intermediate/DF_Performance.rds") %>% 
  clean_names() %>% 
  rename(type = clumped_or_random,
         weeks = num_uniweeks,
         locations = num_points,
         overlap = overlap_mean) %>% 
  mutate(group = factor(group),
         type = factor(ifelse(type == "R", "spread", "concentrated")),
         id = gsub("R", "S", id),
         weeks_std = (weeks - mean(weeks))/sd(weeks),
         locations_std = (locations - mean(locations))/sd(locations),
         xings_std = (xings - mean(xings))/sd(xings),
         raw_locs_std = (raw_locs - mean(raw_locs))/sd(raw_locs),
         hours = locations*2) %>% 
  dplyr::select(group,id,prop,freq,total_points,overlap,hr_area,weeks,locations, weeks_std,locations_std, xings, xings_std, raw_locs_std, raw_locs, type, hours, tau_low, tau, tau_high)
```

## Models

We used binomial models with the number of locations that fall within the UD estimate indicating "successes", and the total points indicate the number of trials.

### Clumped vs Spread (i.e. type) as predictor

Set priors and model
```{r, eval=FALSE}
# set priors
priors_prop <- c(
  prior(normal(0,1.2), class = "b"),
  prior(normal(0,1.5), class = "Intercept"),
  prior(normal(0,1), class = "sd"),
  prior(lkj(3), class = "cor")
)

## model proportion performance 

# with group effects
m_type <- brm(freq | trials(total_points) ~ type + (type|group),
              data = df,
              family = "binomial",
              init  = "0",
              prior = priors_prop,
              
              control = list(adapt_delta = 0.99999,
                             max_treedepth = 14),
              chains = 4, iter = 1000, warmup = 500,
              cores = 4, seed = 520, 
              backend = "cmdstanr"
)

saveRDS(m_type, "Intermediate/Models/model_type.rds")
```

Posterior validation check

```{r}
# read in model
m_type <- readRDS("../Intermediate/Models/model_type.rds")

pp_check(m_type, ndraws = 50)
mcmc_plot(m_type, type = "areas")
```

Plot posterior predictions

```{r, warning=FALSE, message=FALSE, fig.height=8, fig.width=6}
# get posterior predictions
m_type_pred <- m_type %>% 
  epred_draws(newdata = tibble(type = df$type,
                               total_points = df$total_points,
                               group = df$group)) %>% 
  mutate(.epred_prop = .epred/total_points) # change to proportion

# box plot 
p1 <- ggplot(data = m_type_pred, aes(x = type, y = .epred_prop)) +
  geom_half_point(data = df, aes(color = type, y = prop),
                  transformation = position_quasirandom(width = 0.1),
                  side = "l", size = 3, alpha = 0.5) +
  geom_half_boxplot(aes(fill = type), alpha = 0.7, side = "r", outlier.shape = NA) + 
  scale_fill_viridis_d(option = "plasma", end = 0.8) +
  scale_color_viridis_d(option = "plasma", end = 0.8) +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "black", size = 1, alpha = 0.5) +
  scale_y_continuous(lim = c(0.2,1)) +
  guides(color = "none", fill = "none") +
  labs(y = "Performance Score",
       title = "A") +
  theme_bw(base_family = "ArcherPro Book") +
  theme(axis.text = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_blank()) 
  
p1
```

Plot group effects
```{r, warning=FALSE, message=FALSE, fig.height=8, fig.width=8}
ggplot(data = m_type_pred, aes(x = type, y = .epred_prop)) +
  geom_half_point(data = df, aes(color = type, y = prop),
                  transformation = position_quasirandom(width = 0.1),
                  side = "l", size = 3, alpha = 0.5) +
  geom_half_boxplot(aes(fill = type), alpha = 0.7, side = "r", outlier.shape = NA) + 
  scale_fill_viridis_d(option = "plasma", end = 0.8) +
  scale_color_viridis_d(option = "plasma", end = 0.8) +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "black", size = 1, alpha = 0.5) +
  scale_y_continuous(lim = c(0.2,1)) +
  guides(color = "none", fill = "none") +
  labs(x = "Sampling Regularity", y = "Performance Score") +
  theme_bw(base_family = "ArcherPro Book") +
  facet_wrap(~group)
```

Summary stats
```{r}
# summary stats
point_interval(m_type_pred$.epred_prop[m_type_pred$type=="clumped"])
point_interval(m_type_pred$.epred_prop[m_type_pred$type=="spread"])
```

### Number of locations as predictor

Set priors and model

```{r, eval=FALSE}
# set priors
reg_priors <- c(
  prior(normal(0,1), class = "b"),
  prior(normal(0,1.5), class = "Intercept"),
  prior(exponential(0.67), class = "sd"),
  prior(lkj(3), class = "cor")
)

# model with data
m_locs <- brm(
  bf(freq | trials(total_points) ~ locations_std + type + locations_std*type + (locations_std|group)),
  data = df,
  save_pars = save_pars(all=TRUE),
  family = binomial(),
  prior = reg_priors,
  init  = "0",
  control = list(adapt_delta = 0.99999,
                 max_treedepth = 13),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 4, seed = 1234, 
  backend = "cmdstanr"
)

saveRDS(m_locs, "Intermediate/Models/model_locations.rds")
```

Posterior validation check
```{r}

# read in model
m_locs <- readRDS("../Intermediate/Models/model_locations.rds")

# posterior validation
pp_check(m_locs, ndraws = 50) 
mcmc_plot(m_locs, type = 'areas') 
```

Posterior predictions

```{r, message=FALSE}

# add posterior predictions
post_loc_draws <- df %>% 
  data_grid(locations_std = seq_range(-2:3, n =50),
            total_points = total_points,
            type = unique(type),
            group = unique(group)) %>%
  add_predicted_draws(m_locs, ndraws = 200) %>% 
  mutate(.pred_prop = .prediction/total_points)

# get mean prediction
mean_only <- post_loc_draws %>% 
  group_by(locations_std, type) %>%
  summarize(.pred_prop = mean(.pred_prop))

# get real number of locations for x axis sequence
num_locs <- sapply(X = (seq(-2, 3, by = 0.5)),
                   FUN =  function (x) {str_c( "(", as.character(round((x * sd(df$locations)) + mean(df$locations)), digits = 0), ")", sep = "")})

num_locs[2] <- "(0)"

```

Plot predictions

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}

# plot without group effects
p2 <- ggplot(data = post_loc_draws, 
             aes(x = locations_std, 
                 y = .pred_prop, 
                 color = type, 
                 fill = type)) +
  geom_line(stat = "smooth", 
            aes(group = paste(type, .draw)), 
            alpha = 0.03, 
            se = FALSE, 
            lwd = 0.05) + # smooth posterior lines grouped by type
  geom_line(data = mean_only, stat = "smooth", # add mean line
            aes(group = type), lwd = 1.1) +
  geom_point(data = df,
             aes(y = prop), show.legend = FALSE) +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "black", size = 1, alpha = 0.5) +
  annotate("segment", x = 1.15, xend = 1.15, y = -Inf, yend = 0.95,
               linetype = "dashed",
               color = "#370499",
               size = 1,
               alpha = 0.5) +
  annotate("segment", x = 0.9, xend = 0.9, y = -Inf, yend = 0.95,
               linetype = "dashed",
               color = "#feb82c",
               size = 1,
               alpha = 0.5) +
  scale_fill_viridis_d(option = "plasma", end = 0.8) +
  scale_color_viridis_d(option = "plasma", end = 0.8) + 
  scale_x_continuous(limits = c(-1.4,2.5), 
                     breaks = seq(-2, 3, by = 0.5),
                     labels = paste0(seq(-2, 3, by = 0.5), "\n", num_locs)) + # label real weeks underneath standardized
  labs(x = "Number of Recorded Locations",
       y = "Performance Score",
       title = "B") +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_blank(), legend.position = "bottom") +
  guides(color=guide_legend(title="Sampling Regularity")) +
  theme_bw(base_family = "ArcherPro Book") 

p2
```

Plot with group effects
```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=8}

# get mean predictions
mean_only_group <- post_loc_draws %>% 
  group_by(locations_std, type, group) %>%
  summarize(.pred_prop = mean(.pred_prop))

# plot
ggplot(data = post_loc_draws, aes(x = locations_std, y = .pred_prop, color = type, fill = type)) +
  geom_line(stat = "smooth", aes(group = paste(type, .draw)), alpha = 0.03, se = FALSE, lwd = 0.05) + # smooth posterior lines grouped by type
  geom_line(data = mean_only_group, stat = "smooth", # add mean line
            aes(group = type), lwd = 1.1) +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "black", size = 1, alpha = 0.5) +
  scale_fill_viridis_d(option = "plasma", end = 0.8) +
  scale_color_viridis_d(option = "plasma", end = 0.8) + 
  scale_x_continuous(limits = c(-1.4,2.5), 
                     breaks = seq(-2, 3, by = 0.5),
                     labels = paste0(seq(-2, 3, by = 0.5), "\n", num_locs)) + # label real weeks underneath standardized
  labs(x = "Number of Recorded Locations",
       y = "Performance Score") +
  theme_clean() +
  theme_bw(base_family = "ArcherPro Book") +
  theme(legend.title = element_blank(), legend.position = "bottom") +
  facet_wrap(~group)
```

### Number of unique weeks as predictor

Set priors and model

```{r, eval=FALSE}
# model with data
m_weeks <- brm(
  bf(freq | trials(total_points) ~ weeks_std + type + weeks_std*type + (weeks_std|group)),
  data = df,
  save_pars = save_pars(all=TRUE),
  family = binomial(),
  prior = reg_priors,
  init  = "0",
  control = list(adapt_delta = 0.99999,
                 max_treedepth = 13),
  chains = 4, iter = 2000, warmup = 1000,
  cores = 4, seed = 1234, 
  backend = "cmdstanr"
)

saveRDS(m_weeks, "Intermediate/Models/model_weeks.rds")
```

Posterior validation check
```{r}
# read in model
m_weeks <- readRDS("../Intermediate/Models/model_weeks.rds")

# posterior validation
pp_check(m_weeks, ndraws = 50) 
mcmc_plot(m_weeks, type = 'areas') 
```

Posterior predictions

```{r}

# add posterior predictions
post_weeks_draws <- df %>% 
  data_grid(weeks_std = seq_range(-2:3, n =50),
            total_points = total_points,
            type = unique(type),
            group = unique(group)) %>%
  add_predicted_draws(m_weeks, ndraws = 200) %>% 
  mutate(.pred_prop = .prediction/total_points)

# get mean prediction
mean_only <- post_weeks_draws %>% 
  group_by(weeks_std, type) %>%
  summarize(.pred_prop = mean(.pred_prop))

# get real number of weeks for x axis sequence
num_weeks <- sapply(X = (seq(-2, 3, by = 0.5)),
                    FUN =  function (x) {str_c( "(", as.character(round((x * sd(df$weeks)) + mean(df$weeks)), digits = 0), ")", sep = "")})

```

Plot predictions

```{r, message=FALSE, warning=FALSE, fig.height=8, fig.width=8}

# plot without group effects
p3 <- ggplot(data = post_weeks_draws, 
       aes(x = weeks_std, 
           y = .pred_prop, 
           color = type, 
           fill = type)) +
  geom_line(stat = "smooth", # smooth posterior lines grouped by type
            aes(group = paste(type, .draw)), 
            alpha = 0.03, 
            se = FALSE, 
            lwd = 0.05) + 
  geom_line(data = mean_only, # add mean line
            stat = "smooth", 
            aes(group = type), 
            lwd = 1.1) +
  geom_point(data = df,
             aes(y = prop), show.legend = FALSE) +
  geom_hline(yintercept = 0.95, 
             linetype = "dashed",
             color = "black", 
             size = 1, alpha = 0.5) +
  annotate("segment", x = 1.4, xend = 1.4, y = -Inf, yend = 0.95,
               linetype = "dashed",
               color = "#feb82c",
               size = 1,
               alpha = 0.5) +
  annotate("segment", x = 0.35, xend = 0.35, y = -Inf, yend = 0.95,
               linetype = "dashed",
               color = "#370499",
               size = 1,
               alpha = 0.5) +
  scale_fill_viridis_d(option = "plasma", end = 0.8) +
  scale_color_viridis_d(option = "plasma", end = 0.8) + 
  scale_x_continuous(limits = c(-1.4,2.5), 
                     breaks = seq(-2, 3, by = 0.5),
                     labels = paste0(seq(-2, 3, by = 0.5), "\n", num_weeks)) + # label real weeks underneath standardized
  labs(x = "Number of Unique Weeks",
       y = "Performance Score",
       title = "C") +
  theme(axis.text = element_text(size = 12),
        axis.title = element_text(size = 14),
        legend.title = element_blank(), legend.position = "bottom") +
  guides(color=guide_legend(title="Sampling Regularity")) +
  theme_bw(base_family = "ArcherPro Book") 

p3
```

```{r, include=FALSE}

p4 <- p1 + p2/p3 + plot_layout(guides = "collect") & theme(legend.position = 'bottom')

# Save plot
file.name.model.preds <- paste0("model_prediction_plots_",
                                format(Sys.time(), "%Y_%m_%d_%H%M%S"), ".jpg")

ggsave(here::here("Figures", file.name.model.preds),
       plot = p4,
       width = 3300,
       height = 3000,
       units = "px")
```


Plot with group effects
```{r, message=FALSE, warning=FALSE, fig.height=6, fig.width=8}

# get mean predictions
mean_only_group <- post_weeks_draws %>% 
  group_by(weeks_std, type, group) %>%
  summarize(.pred_prop = mean(.pred_prop))

# plot
ggplot(data = post_weeks_draws, aes(x = weeks_std, y = .pred_prop, color = type, fill = type)) +
  geom_line(stat = "smooth", aes(group = paste(type, .draw)), alpha = 0.03, se = FALSE, lwd = 0.05) + # smooth posterior lines grouped by type
  geom_line(data = mean_only_group, stat = "smooth", # add mean line
            aes(group = type), lwd = 1.1) +
  geom_hline(yintercept = 0.95, linetype = "dashed", color = "black", size = 1, alpha = 0.5) +
  scale_fill_viridis_d(option = "plasma", end = 0.8) +
  scale_color_viridis_d(option = "plasma", end = 0.8) + 
  scale_x_continuous(limits = c(-1.4,2.5), 
                     breaks = seq(-2, 3, by = 0.5),
                     labels = paste0(seq(-2, 3, by = 0.5), "\n", num_weeks)) + # label real weeks underneath standardized
  labs(x = "Coarse-Scale Volume (# weeks)",
       y = "Performance Value") +
  theme_clean() +
  theme_bw(base_family = "ArcherPro Book") +
  theme(legend.title = element_blank(), legend.position = "bottom") +
  facet_wrap(~group)
```

## Slope Coefficients plot

This plot compares the posterior distributions of the slope at varying standardized values on the x-axis

```{r}
# clumped locations
ame_locs_clumped <- m_locs %>% 
  emtrends(~ locations_std*type, var = "locations_std",
           at = list(type = "concentrated", locations_std = c(-1.3, -0.8, -0.3, 0.2)),
           regrid = "response") %>% 
  gather_emmeans_draws() %>% 
  mutate(labels = str_c(as.character(locations_std), 
                        " (", 
                        as.character(round((locations_std * sd(df$locations)) + mean(df$locations)),
                                     digits = 0), 
                        ")", 
                        sep = ""))

levels.1 <- c("-1.3 (21)", "-0.8 (142)", "-0.3 (264)", "0.2 (385)")


p1 <- ggplot(ame_locs_clumped, aes(x = .value, 
                                   fill = factor(labels,levels = levels.1))) +
  geom_vline(xintercept = 0) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               slab_alpha = 0.75) +
  scale_fill_viridis_d(option = "plasma", begin = 0, end = 0.4) +
  coord_cartesian(xlim = c(-0.05,0.5)) +
  labs(x = "Instantaneous Slope Coefficients", 
       y = "Density", fill = "Standardized Locations",
       #caption = "80% and 95% credible intervals shown in black",
       title = "A",
       caption = "Effect of Increasing Locations on Concentrated Regimes") +
  theme_bw(base_family = "ArcherPro Book") +
  theme(legend.position=c(.73,.65),
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=11),
        legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width 
        legend.background = element_rect(fill=alpha(0.1)),
        axis.title = element_blank(),
        plot.caption = ggtext::element_markdown(hjust = 0.5))

# spread locations
ame_locs_spread <- m_locs %>% 
  emtrends(~ locations_std*type, var = "locations_std",
           at = list(type = "spread", locations_std = c(-1.3, -0.8, -0.3, 0.2)),
           regrid = "response") %>% 
  gather_emmeans_draws() %>% 
  mutate(labels = str_c(as.character(locations_std), 
                        " (", 
                        as.character(round((locations_std * sd(df$locations)) + mean(df$locations)),
                                     digits = 0), 
                        ")", 
                        sep = ""))

p2 <- ggplot(ame_locs_spread, aes(x = .value, 
                                  fill = factor(labels,levels = levels.1))) +
  geom_vline(xintercept = 0) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               slab_alpha = 0.75) +
  scale_fill_viridis_d(option = "plasma", begin = 0.6, end = 1) +
  coord_cartesian(xlim = c(-0.05,0.5)) +
  labs(x = "Instantaneous Slope Coefficients", 
       y = "Density", fill = "Standardized Locations",
       #caption = "80% and 95% credible intervals shown in black",
       title = "B",
       caption = "Effect of Increasing Locations on Spread Regimes") +
  theme_bw(base_family = "ArcherPro Book") +
  theme(legend.position=c(.7,.65),
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=11),
        legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width 
        legend.background = element_rect(fill=alpha(0.1)),
        axis.text.y=element_blank(),
        axis.title = element_blank(),
        plot.caption = ggtext::element_markdown(hjust = 0.5))

# clumped weekss
ame_weeks_clumped <- m_weeks %>% 
  emtrends(~ weeks_std*type, var = "weeks_std",
           at = list(type = "concentrated", weeks_std = c(-1.3, -0.8, -0.3, 0.2)),
           regrid = "response") %>% 
  gather_emmeans_draws() %>% 
  mutate(labels = str_c(as.character(weeks_std), 
                        " (", 
                        as.character(round((weeks_std * sd(df$weeks)) + mean(df$weeks)),
                                     digits = 0), 
                        ")", 
                        sep = ""))

levels.2 <- c("-1.3 (1)", "-0.8 (2)", "-0.3 (4)", "0.2 (6)")

p3 <- ggplot(ame_weeks_clumped, aes(x = .value, 
                                    fill = factor(labels, levels = levels.2))) +
  geom_vline(xintercept = 0) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               slab_alpha = 0.75) +
  scale_fill_viridis_d(option = "plasma", begin = 0, end = 0.4) +
  coord_cartesian(xlim = c(-0.05,0.5)) +
  labs(x = "Instantaneous Slope Coefficients", 
       y = "Density", fill = "Standardized Weeks",
       #caption = "80% and 95% credible intervals shown in black",
       title = "C",
       caption = "Effect of Increasing Weeks on Concentrated Regimes") +
  theme_bw(base_family = "ArcherPro Book") +
  theme(legend.position=c(.7,.65),
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=11),
        legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width 
        legend.background = element_rect(fill=alpha(0.1)),
        axis.title = element_blank(),
        plot.caption = ggtext::element_markdown(hjust = 0.5))

# spread weeks
ame_weeks_spread <- m_weeks %>% 
  emtrends(~ weeks_std*type, var = "weeks_std",
           at = list(type = "spread", weeks_std = c(-1.3, -0.8, -0.3, 0.2)),
           regrid = "response") %>% 
  gather_emmeans_draws() %>% 
  mutate(labels = str_c(as.character(weeks_std), 
                        " (", 
                        as.character(round((weeks_std * sd(df$weeks)) + mean(df$weeks)),
                                     digits = 0), 
                        ")", 
                        sep = ""))

p4 <- ggplot(ame_weeks_spread, aes(x = .value, 
                                   fill = factor(labels, levels = levels.2))) +
  geom_vline(xintercept = 0) +
  stat_halfeye(.width = c(0.8, 0.95), point_interval = "median_hdi",
               slab_alpha = 0.75) +
  scale_fill_viridis_d(option = "plasma", begin = 0.6, end = 1) +
  coord_cartesian(xlim = c(-0.05,0.5)) +
  labs(x = "Instantaneous Slope Coefficients", 
       y = "Density", fill = "Standardized Weeks",
       #caption = "80% and 95% credible intervals shown in black",
       title = "D",
       caption = "Effect of Increasing Weeks on Spread Regimes") +
  theme_bw(base_family = "ArcherPro Book") +
  theme(legend.position=c(.7,.65),
        legend.title = element_text(size=14), #change legend title font size
        legend.text = element_text(size=11),
        legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width 
        legend.background = element_rect(fill=alpha(0.1)),
        axis.text.y=element_blank(),
        axis.title = element_blank(),
        plot.caption = ggtext::element_markdown(hjust = 0.5))
```

Plot

```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=8}
## function to get global axes
add_global_label <- function(pwobj, Xlab = NULL, Ylab = NULL, Xgap = 0.03, Ygap = 0.03, ...) {
  ylabgrob <- patchwork::plot_spacer()
  if (!is.null(Ylab)) {
    ylabgrob <- ggplot() +
      geom_text(aes(x = .5, y = .5), label = Ylab, angle = 90, ...) +
      theme_void()
  }
  if (!is.null(Xlab)) {
    xlabgrob <- ggplot() +
      geom_text(aes(x = .5, y = .5), label = Xlab, ...) +
      theme_void()
  }
  if (!is.null(Ylab) & is.null(Xlab)) {
    return((ylabgrob + patchworkGrob(pwobj)) + 
             patchwork::plot_layout(widths = 100 * c(Ygap, 1 - Ygap)))
  }
  if (is.null(Ylab) & !is.null(Xlab)) {
    return((ylabgrob + pwobj) + 
             (xlabgrob) +
             patchwork::plot_layout(heights = 100 * c(1 - Xgap, Xgap),
                                    widths = c(0, 100),
                                    design = "
                                   AB
                                   CC
                                   "
             ))
  }
  if (!is.null(Ylab) & !is.null(Xlab)) {
    return((ylabgrob + pwobj) + 
             (xlabgrob) +
             patchwork::plot_layout(heights = 100 * c(1 - Xgap, Xgap),
                                    widths = 100 * c(Ygap, 1 - Ygap),
                                    design = "
                                   AB
                                   CC
                                   "
             ))
  }
  return(pwobj)
}

# plot together
p5 <- ((p1 + p2 + p3 + p4) + plot_layout(ncol = 2)) %>% 
  add_global_label(Ylab = "Density",
                   Xlab = "Instantaeous Slope Coefficients",
                   size = 7)

p5
```

```{r, include=FALSE}
# Save plot
file.name.model.slopes <- paste0("model_slope_plots_",
                                format(Sys.time(), "%Y_%m_%d_%H%M%S"), ".jpg")

ggsave(here::here("Figures", file.name.model.slopes),
       plot = p5,
       width = 3300,
       height = 3000,
       units = "px")
```

